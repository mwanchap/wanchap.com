+++
title = "Umbraco Deployment Checklist"
date = 2017-01-10T16:41:00Z
updated = 2017-11-30T16:31:09Z
blogimport = true 
[author]
	name = "Matt Wanchap"
	uri = "https://www.blogger.com/profile/16465307324394182190"
+++

This is primarily aimed at deploying from Visual Studio to an Azure Web App + Azure SQL database, feel free to skip bits that aren't relevant if you're doing other things.<br /><br /><b>Prerequisites for developing locally:</b><br />Visual Studio (obviously)<br />Ensure IIS URL Rewrite module is installed using web platform installer (other downloads from MS documentation don't seem to work)<br /><br /><b>Set up Azure:</b><br />Make a new SQL Database in Azure, take note of the server name, database name, admin login and admin password.&nbsp; If you already have a server and resource group, automate with Powershell as shown below (you'll need to replace the param values):<br /><code>New-AzureRmSqlDatabase -DatabaseName "UmbracoDatabase" -ServerName "TheServer" -ResourceGroupName "Whatever" -Edition "Basic"</code><br />Add your IP to the Azure SQL db firewall so Umbraco can connect to it later when running locally<br />Create a new Azure web app, either manually or via Powershell:<br /><code>New-AzureRmWebApp -ResourceGroupName "Whatever" -Name "UmbracoWebsite" -Location "AustraliaEast" -AppServicePlan "YourASP"</code><br /><div><div>Set "PHP Version" to "Off"</div></div><br /><b>Create the project:</b><br />Open VS and make a new ASP.NET Web Application, targeting the latest release version of .NET, and select the "Empty" project template<br />Open the Package Manager Console, and run "Install-Package UmbracoCms"<br />Once that's done, build &amp; run your VS solution (debug mode is fine)<br />Put your admin account details into the install page<br />Click "Customize", <b>not</b> "Install"!<br />Select "Microsoft SQL Azure" as the target database and enter the server/admin details<br />Probably don't install a starter pack<br />If everything worked, you should be logged into the Umbraco backend on localhost<br /><br /><b>Pre-deployment:</b><br />Set&nbsp;&lt;customErrors mode="Off" /&gt; in web.config. &nbsp;Remember to change this back later.<br />Delete the Umbraco/Install folder<br /><div>Copy the .gitignore from <a href="https://github.com/github/gitignore/blob/master/Umbraco.gitignore">https://github.com/github/gitignore/blob/master/Umbraco.gitignore</a> to your project's root and obviously save as .gitignore<br />While you're at it, make sure you have a Visual Studo gitignore set up too: <a href="https://github.com/github/gitignore/blob/master/VisualStudio.gitignore">https://github.com/github/gitignore/blob/master/VisualStudio.gitignore</a><br />Do the usual new git project stuff: git init / add / commit / remote add origin / push origin master<br />Include \App_Data\ in the solution, but only \App_Data\packages\, and \App_Data\Models\ (and the models once you've compiled your models, depending on your ModelsBuilder setting). Exclude everything else under \App_Data\ like logs, nugetbackup, temp and umbraco.config etc.<br />If you were using a starter kit, include everything from that too (make sure you have "Show all files" selected in Solution Explorer)<br />Add this URL rewrite rule to redirect from /admin to /umbraco:<br />&lt;rewrite&gt;<br />&nbsp; &nbsp; &lt;rules&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;rule name="Umbraco Admin" enabled="true" stopProcessing="true"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;match url="^admin$" /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;action type="Redirect" url="/umbraco" appendQueryString="false" redirectType="Temporary" /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;/rule&gt;<br />&nbsp; &nbsp; &lt;/rules&gt;<br />&lt;/rewrite&gt;</div><div><br /></div><div><b>Deployment:</b></div><div>Publish via VS' web publish (right click project node, "Publish")<br />Don't use git-based deployments because the contents of \Media\ changes whenever users upload files, and a git-based deployment will erase any changes they make there.<br />It's easier to use Azure blob storage for media (see below) to avoid storing media files inside the site at all.&nbsp; But if you're leaving media in \Media\, make sure you keep the git repo up-to-date.&nbsp; Before a publish always right-click "Media" in VS and select "Replace Media from server". &nbsp;Publishing <i>without </i>doing this won't delete people's file uploads, but any file links will break if you ever try to clone the site from git.<br /><br />Azure AD integration<br />https://www.jdibble.co.uk/blog/securing-umbraco-backoffice-with-azure-active-directory/<br />https://stackoverflow.com/questions/40301349/azure-ad-identity-doesnt-seem-to-provide-email-for-auto-linking-umbraco-user<br /><br /><b>Azure blob storage integration:</b><br />Using the "media" folder to store media sucks if you're using source control and are running a large site with lots of constantly-changing media files.&nbsp; There's a better way!&nbsp; Install this package:&nbsp;https://www.nuget.org/packages/UmbracoFileSystemProviders.Azure/<br />And then configure it like this: https://github.com/JimBobSquarePants/UmbracoFileSystemProviders.Azure</div><div><br /></div><div><b>Setting up Umbraco itself:</b></div><div>Setting up your document types can happen either locally or on the server (since they write to the same db)</div><div>Always do all your coding (like templates) locally in Visual Studio, commit to git and deploy to the server. &nbsp;Don't edit code within Umbraco itself, unless you aren't using version control and don't care about Visual Studio's vastly superior editor, debugging, etc.<br />If you don't know what to do from here, go to http://umbraco.tv/ and learn how to Umbraco ;)</div><div><br /></div><b>Post-deployment / going live:</b><br />Remember to put &lt;customErrors mode="Off" /&gt; back to how it was in web.config (either "RemoteOnly" or ideally "On" with some error handling)<br />Set up google analytics (optional)<br />Set up app insights (optional). &nbsp;Note that it'll add some stuff to the &lt;log4net&gt; section of web.config, which broke it during automated setup. Copy the new content into config\log4net.config<br />Go through everything in Umbraco's back office -&gt; Developer -&gt; Health Check<br />Once everything is set up and you're ready to launch the site:<br />The below isn't essential, but useful:<br />Turn Umbraco's logging off (/config/umbracoSettings.config)<br />Set umbracoDebugMode to false<br />Set up custom error pages<br />Set custumerrors mode="Off"<br />Set &lt;compilation debug="false" /&gt;<br />Set &lt;trace enabled="false"<br />Set umbracoDisableVersionCheck to true<br /><br />Add the following in the disabledLogTypes node:<br /><br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;debug&lt;/logTypeAlias&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;notfound&lt;/logTypeAlias&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;open&lt;/logTypeAlias&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;packagerinstall&lt;/logTypeAlias&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;packageruninstall&lt;/logTypeAlias&gt;<br /><span class="Apple-tab-span" style="white-space: pre;">  </span>&lt;logTypeAlias&gt;ping&lt;/logTypeAlias&gt;<br /><div><br /></div><div><b>Remote debugging:</b></div><div>This feature is so handy I thought I'd make a section for it</div><div>In Visual Studio, do a web deploy in "Debug" mode</div><div>In the Server Explorer pane, find your web app, right click and select "Attach Debugger"<br />Obviously &nbsp;make sure to set "Remote debugging" to "Off" in the Azure Web App "Application Settings" page once you're done. &nbsp;It turns off automatically in 48 hours anyway, but still.</div><br /><b>Other points:</b><br />This is an excellent checklist of other things:<br />https://github.com/engern/Umbraco-Deployment-Checklist<br />The easiest way to make a copy of the SQL database for testing is to click the "Copy" button on the database's "Overview" page in Azure. &nbsp;These are priced at cents per hour, so just delete it when you're done testing. &nbsp;It's so easy to make a new one that you probably don't need to keep it around once you're done.<br />Otherwise if you want to load it elsewhere, click "Export" and save a backup, then download that and restore to another database of your choice.<br />Sync file updates from Azure to VS (e.g. when people upload files)<br /><br /><b>Azure AD integration:</b><br />First do this:<br />https://www.jdibble.co.uk/blog/securing-umbraco-backoffice-with-azure-active-directory/<br />Then do this:<br />https://stackoverflow.com/questions/40301349/azure-ad-identity-doesnt-seem-to-provide-email-for-auto-linking-umbraco-user<br />In web.config, change the "owin:appStartup" key's value to "UmbracoStandardOwinStartup"<br />Remember to add the app's URL including /umbraco to the list of reply URL's in Azure<br /><br />Inside the code block for new&nbsp;OpenIdConnectAuthenticationOptions:<br />Change the "email" line of AuthorizationCodeReceived to:<br />var email = context.JwtSecurityToken.Claims.First(x =&gt; x.Type == "upn").Value;<br /><br />Change the "if user == null" part to<br />if (user == null)<br />{<br />&nbsp; &nbsp; user = userService.CreateUserWithIdentity(email, email);//, writerUserType);<br />}<br /><br />Change the last bit to:<br />adOptions.SetExternalSignInAutoLinkOptions(new ExternalSignInAutoLinkOptions(autoLinkExternalAccount: true, defaultUserGroups: new string[] { "writer" }, defaultCulture: null));<br /><br />TODO: ModelsBuilder modes<br /><br />Other sources not already mentioned:<br />https://our.umbraco.org/documentation/getting-started/setup/install/install-umbraco-with-nuget<br />https://caveofcode.com/2016/03/how-to-setup-umbraco-locally-and-on-azure/
