+++
title = "TSQL - Removing a trailing comma from a list of concatenated values"
date = 2014-01-19T16:38:00Z
updated = 2014-02-19T21:21:19Z
tags = ["T-SQL"]
blogimport = true 
[author]
	name = "Matt Wanchap"
	uri = "https://www.blogger.com/profile/16465307324394182190"
+++

On a semi-regular basis I'd need to squish a list of comma-delimited values all concatenated together into one field, so I'd use this old snippet:<br /><br /><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="color: blue; font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">SELECT</span><span style="font-family: 'Courier New'; font-size: 10pt;">&nbsp;</span><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;"><span style="color: grey;">LEFT(</span>ConcatValues<span style="color: grey;">,</span> <span style="color: magenta;">LEN</span><span style="color: grey;">(</span>ConcatValues<span style="color: grey;">)-</span>1<span style="color: grey;">)</span> <span style="color: blue;">AS</span> <span style="color: red;">'TheValues'<o:p></o:p></span></span></div><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="color: blue; font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">FROM&nbsp;</span><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">SomeTable t<o:p></o:p></span></div><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: grey;">CROSS</span> <span style="color: grey;">APPLY</span><span style="color: blue;"> </span><span style="color: grey;">(</span> <span style="color: blue;">SELECT</span>&nbsp;&nbsp;&nbsp; t2<span style="color: grey;">.</span>SomeField <span style="color: grey;">+</span> <span style="color: red;">', '</span> <span style="color: blue;">AS</span> [text()]<o:p></o:p></span></div><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SomeTable t2<o:p></o:p></span></div><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; mso-no-proof: yes;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">WHERE</span>&nbsp; &nbsp; &nbsp;t<span style="color: grey;">.</span>SomeField <span style="color: grey;">=</span> t2<span style="color: grey;">.</span>SomeField<o:p></o:p></span></div><br /><div class="MsoNormal"><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; line-height: 107%; mso-no-proof: yes;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">FOR</span> <span style="color: blue;">XML</span> <span style="color: blue;">PATH</span><span style="color: grey;">(</span><span style="color: red;">''</span><span style="color: grey;">)</span> <span style="color: grey;">)</span> C<span style="color: blue;"> </span><span style="color: grey;">(</span>ConcatValues<span style="color: grey;">)</span></span><o:p></o:p></div><div class="MsoNormal"><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; line-height: 107%; mso-no-proof: yes;"><span style="color: grey;"><br /></span></span></div>Problem is when the concatenated field has length zero, LEFT gets a -1 length and returns an error:<br /><div><br /><div><div class="MsoNormal" style="margin-bottom: 0.0001pt;"><span style="color: red; font-family: &quot;Courier New&quot;; font-size: 8.0pt; mso-no-proof: yes;">Msg 537, Level 16, State 5, Line 1<o:p></o:p></span></div><div class="MsoNormal"><span style="color: red; font-family: &quot;Courier New&quot;; font-size: 8.0pt; line-height: 107%; mso-no-proof: yes;">Invalid length parameter passed to the LEFT or SUBSTRING function.</span><span style="color: red;"><o:p></o:p></span></div></div><div><br /></div><div>So today I had a look around and found a better way from <a href="http://stackoverflow.com/questions/427851/query-to-replace-a-comma-in-sql">this StackOverflow thread</a>.&nbsp;Just replace the LEFT function with this:</div></div><div><br /></div><div><div class="MsoNormal"><span style="color: magenta; font-family: &quot;Courier New&quot;; font-size: 10.0pt; line-height: 107%; mso-no-proof: yes;">STUFF</span><span style="color: grey; font-family: &quot;Courier New&quot;; font-size: 10.0pt; line-height: 107%; mso-no-proof: yes;">(</span><span style="font-family: &quot;Courier New&quot;; font-size: 10.0pt; line-height: 107%; mso-no-proof: yes;">ConcatValues<span style="color: grey;">,</span><span style="color: magenta;">LEN</span><span style="color: grey;">(</span>ConcatValues<span style="color: grey;">),</span> 1<span style="color: grey;">,</span> <span style="color: red;">''</span><span style="color: grey;">)</span></span><o:p></o:p></div></div><div><br /></div><div>It gives the exact same results except that the STUFF function is way more tolerant of being given inappropriate length parameters and just returns NULL (which is exactly what I want)&nbsp;instead of throwing errors. &nbsp;From the <a href="http://technet.microsoft.com/en-us/library/ms188043.aspx">MSDN documentation</a>:</div><div><br /></div><div>"<span style="color: #2a2a2a; font-family: 'Segoe UI', 'Lucida Grande', Verdana, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 18px;">If the start position or the length is negative, or if the starting position is larger than length of the first string, a null string is returned. If the start position is 0, a null value is returned. If the length to delete is longer than the first string, it is deleted to the first character in the first string</span>"</div><div><br /></div>
