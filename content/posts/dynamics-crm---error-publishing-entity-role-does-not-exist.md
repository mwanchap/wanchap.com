+++
title = "Dynamics CRM - error publishing entity, role does not exist"
date = 2014-08-05T15:59:00Z
updated = 2014-08-05T15:59:00Z
tags = ["T-SQL", "Dynamics CRM 2011"]
blogimport = true 
[author]
	name = "Matt Wanchap"
	uri = "https://www.blogger.com/profile/16465307324394182190"
+++

This morning I was trying to add a new option to an option set field for a custom entity I had made earlier, however an error dialog popped up which said "The requested record is unavailable or you have insufficient permission to view the record", even though I'm in a System Administrator role. &nbsp;Upon downloading the exception details and examining them, the actual error was this:<br /><br />role With Id = dba45c71-05e2-e311-9210-0050568f0001 Does Not Exist<br /><br />At one point there were multiple custom roles and multiple forms associated with this entity, configured such that people in an employee role could see one form and people in a manager/admin role could see a different form with more fields, things like that. &nbsp;Later on this functionality wasn't required so I deleted all but one of the custom forms and roles, however it turns out that this form still had references to those custom roles.<br /><br />There wasn't much information around about this, and all the solutions I could find were like <a href="https://community.dynamics.com/crm/f/117/p/73740/135685.aspx">https://community.dynamics.com/crm/f/117/p/73740/135685.aspx</a> referring to just deleting various things like custom forms, which seemed like a pretty weak solution to me. &nbsp;I searched the database for a form containing a reference to the missing security role:<br /><br /><code>SELECT &nbsp;formxml<br />FROM &nbsp; &nbsp;FilteredSystemForm<br />where<span class="Apple-tab-span" style="white-space: pre;"> </span>formxml like '%dba45c71-05e2-e311-9210-0050568f0001%'</code><br /><br />This showed that the form's XML contained the following section right at the end:<br /><br /><code>&lt;DisplayConditions FallbackForm="true"&gt;<br />&nbsp; &nbsp; &lt;Role Id="{D2A56150-05E2-E311-9210-0050568F0001}" /&gt;<br />&nbsp; &nbsp; &lt;Role Id="{DBA45C71-05E2-E311-9210-0050568F0001}" /&gt;<br />&nbsp; &nbsp; &lt;Role Id="{DB70F508-654A-DD11-BE40-001E4F1B8E8B}" /&gt;<br />&nbsp; &nbsp; &lt;Role Id="{4F7AF508-654A-DD11-BE40-001E4F1B8E8B}" /&gt;<br />&lt;/DisplayConditions&gt;</code><br /><br />The MSDN documentation for this section (<a href="http://msdn.microsoft.com/en-us/library/gg334497.aspx">http://msdn.microsoft.com/en-us/library/gg334497.aspx</a>) shows that you can also use an &lt;Everyone&gt; element instead of the &lt;Role&gt; elements, and since I only had one form now it was no longer necessary to deal with security roles. &nbsp;I tried updating this the Microsoft-approved way with the form editor, but this threw another error at me when I tried to update it to "Everyone" probably again due to the missing security roles. &nbsp;So my only option was to edit the form directly in the database, which looked something like this (not the full command - don't copy this):<br /><br /><code>UPDATE<span class="Apple-tab-span" style="white-space: pre;"> </span>systemformbase<br />SET<span class="Apple-tab-span" style="white-space: pre;"> </span>formxml = 'loads of XML ending with &lt;DisplayConditions FallbackForm="true"&gt;&lt;Everyone /&gt;&lt;/DisplayConditions&gt;&lt;/form&gt;'<br />WHERE formid = 'the form's guid'</code><br /><br />Seriously don't copy/paste that or you might wreck your form (I really shouldn't need to say that but you know how people are). Anyway, that solved my problem without needing to delete anything! &nbsp;Hopefully it helps you solve yours too :)
